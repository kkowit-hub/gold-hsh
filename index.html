<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GOLD LIVE PRO - Sync Fixed</title>
    <style>
        :root { --gold: #ffd700; --bg: #000; --buy: #ff4d4d; --sell: #00e676; --usd: #4da3ff; }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Tahoma', sans-serif; margin: 0; padding: 0; 
            background-color: var(--bg); color: white; 
            height: 100svh; width: 100vw; overflow: hidden;
            display: grid; grid-template-rows: auto 1fr auto;
            padding-top: env(safe-area-inset-top);
        }
        .top-bar { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: #000; }
        .brand-section { display: flex; align-items: center; gap: 10px; }
        .header-title { color: var(--gold); font-size: 0.9rem; font-weight: bold; margin: 0; line-height: 1.2; }
        .live-data-group { display: flex; align-items: center; gap: 10px; }
        .live-prices { display: flex; gap: 8px; font-weight: 900; font-size: 1.1rem; }
        .forex-mini { display: flex; align-items: center; gap: 3px; border-left: 1px solid #333; padding-left: 8px; }
        .p-buy { color: var(--buy); } .p-sell { color: var(--sell); } 
        .fx-val { color: var(--usd); font-weight: 800; font-size: 1rem; }
        .p-label { font-size: 0.6rem; color: #888; font-weight: normal; margin-right: 2px; }
        .status-bar { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: #444; }
        select { background: #111; border: 1px solid #333; color: var(--gold); border-radius: 4px; font-size: 0.7rem; }
        .chart-main { flex: 1; border-radius: 8px; overflow: hidden; border: 1px solid #222; margin: 0 5px 5px 5px; }
        .footer { text-align: center; font-size: 0.5rem; color: #222; padding: 4px 0; padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
<header class="top-bar">
    <div class="brand-section">
        <h1 class="header-title">GOLD<br>LIVE PRO</h1>
        <div class="live-data-group">
            <div class="live-prices">
                <div class="p-buy"><span class="p-label">B:</span><span id="buyPrice">---</span></div>
                <div class="p-sell"><span class="p-label">S:</span><span id="sellPrice">---</span></div>
            </div>
            <div class="forex-mini">
                <span class="p-label" style="color:var(--usd)">USD:</span>
                <span id="usdThbPrice" class="fx-val">--.--</span>
            </div>
        </div>
    </div>
    <div class="status-bar">
        <select id="refreshInterval" onchange="updateRefreshRate()">
            <option value="15">15s</option>
            <option value="30">30s</option>
            <option value="60" selected>60s</option>
        </select>
        <span id="updateTime">--:--:--</span>
    </div>
</header>
<main style="display:flex; flex-direction:column; overflow:hidden;">
    <div class="chart-main">
        <div id="tradingview_gold" style="height:100%;width:100%"></div>
    </div>
</main>
<footer class="footer">SYNO DS920+ • @KoeConbot</footer>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    new TradingView.widget({
        "autosize": true, "symbol": "FX_IDC:XAUUSD", "interval": "60", "timezone": "Asia/Bangkok",
        "theme": "dark", "style": "1", "locale": "th", "container_id": "tradingview_gold"
    });

    let refreshTimer;
    // URL ngrok จาก n8n ของคุณ
    const n8nBase = "https://fierily-unelated-rosamaria.ngrok-free.dev"; 

    async function updateAll() {
        try {
            const res = await fetch(`${n8nBase}/webhook/gold-price?t=${Date.now()}`, { 
                headers: { 'ngrok-skip-browser-warning': 'true' } 
            });
            const data = await res.json();
            
            // เข้าถึงไอเทมแรกจาก n8n (รองรับทั้งแบบ Array และ Object)
            const item = Array.isArray(data) ? data[0] : data;
            
            if (item) {
                // อัปเดตราคาทอง และล้างเครื่องหมายสัญลักษณ์ออก
                const cleanBuy = item.Buy ? item.Buy.toString().replace(/[=,]/g, '') : "---";
                const cleanSell = item.Sell ? item.Sell.toString().replace(/[=,]/g, '') : "---";
                
                document.getElementById('buyPrice').innerText = cleanBuy;
                document.getElementById('sellPrice').innerText = cleanSell;
                
                // ดึงค่า USDTHB (31.14) จาก n8n โดยตรง
                // ใช้การดึงชื่อตัวแปรที่ตรงกับใน n8n
                const forexVal = item.USDTHB || item.usdthb || "--.--";
                document.getElementById('usdThbPrice').innerText = forexVal;
                
                document.getElementById('updateTime').innerText = new Date().toLocaleTimeString('th-TH');
                document.getElementById('updateTime').style.color = "#888";
            }
        } catch (e) { 
            document.getElementById('updateTime').innerText = "OFFLINE";
            document.getElementById('updateTime').style.color = "#ff4d4d";
            console.error("Fetch Error:", e);
        }
    }

    function updateRefreshRate() {
        const s = document.getElementById('refreshInterval').value;
        localStorage.setItem('goldForexRate', s);
        clearInterval(refreshTimer);
        refreshTimer = setInterval(updateAll, s * 1000);
    }

    const savedRate = localStorage.getItem('goldForexRate') || "60";
    document.getElementById('refreshInterval').value = savedRate;
    updateAll();
    refreshTimer = setInterval(updateAll, savedRate * 1000);
</script>
</body>
</html>
